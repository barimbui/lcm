<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LCM ‚Äî Communities</title>

  <!-- Shared theme -->
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase v2 (must load before supabaseClient.js & any page scripts) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script defer src="supabaseClient.js"></script>

  <style>
    .wrap { max-width: 1100px; margin: 16px auto; padding: 0 12px; }
    .community-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
    .community-card {
      background: var(--panel); border: 1px solid var(--gray-700);
      border-radius: 16px; padding: 12px; box-shadow: 0 8px 24px rgba(0,0,0,.35);
      display: flex; flex-direction: column; min-height: 160px;
    }
    .card-head { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
    .card-title { font-weight: 800; color: var(--text); letter-spacing: .3px; }
    .count-pill {
      margin-left: auto; background: #121218; color: var(--muted);
      border: 1px solid var(--purple); border-radius: 999px; padding: 2px 8px; font-size: 12px;
    }
    .actions { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .btn-ghost {
      background: transparent; border: 1px solid var(--gray-700); border-radius: 10px;
      color: var(--text); padding: 6px 8px; cursor: pointer; text-decoration: none;
    }
    .list { margin: 0; padding-left: 16px; list-style: disc; color: var(--muted); display: none; }
    .list.show { display: block; }

    .bar { display:flex; align-items:center; gap:10px; margin: 10px 0; }
    .spacer { flex: 1 1 auto; }
    .btn-primary { background: var(--purple); color:#fff; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn-secondary { background: transparent; color: var(--text); border:1px solid var(--gray-700); padding:8px 12px; border-radius:10px; cursor:pointer; }

    .inline-form {
      display:none; background: #0f0f14; border:1px solid var(--gray-700);
      border-radius: 12px; padding: 12px; margin: 10px 0;
    }
    .inline-form.show { display:block; }
    .inline-form input[type="text"]{
      width:100%; background:#0f0f14; color:var(--text); border:1px solid var(--gray-700);
      border-radius:10px; padding:10px 12px; margin-top:6px;
    }
    .hint { color: var(--muted); font-size: 12px; }

    .custom-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .meta { color: var(--muted); font-size: 12px; margin-top: 6px; }

    /* Invite modal (unchanged from earlier) */
    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.55); z-index: 50; }
    .modal.open { display: grid; }
    .modal-card { width: min(680px, 92vw); background: var(--panel); border: 1px solid var(--gray-700); border-radius: 16px; box-shadow: 0 12px 40px rgba(0,0,0,.6); padding: 16px; }
    .modal-head { display:flex; align-items:center; gap:8px; margin-bottom: 8px; }
    .modal-title { color: var(--text); font-weight: 800; }
    .tabs { display:flex; gap:8px; margin: 8px 0 12px; }
    .tab { padding:6px 10px; border-radius: 10px; border:1px solid var(--gray-700); cursor:pointer; }
    .tab.active { border-color: var(--purple); }
    .row { display:flex; align-items:center; gap:10px; }
    .field { margin: 8px 0; }
    .field input { width:100%; background:#0f0f14; color:var(--text); border:1px solid var(--gray-700); border-radius:10px; padding:10px 12px; }
    .results { margin-top: 8px; display: grid; gap: 8px; }
    .result-item { display:flex; align-items:center; gap:10px; padding:8px; border:1px solid var(--gray-700); border-radius: 10px; background:#0f0f14; }
    .avatar { width:36px; height:36px; border-radius:50%; object-fit:cover; background:#111; }
    .rname { color: var(--text); font-weight: 700; }
    .rmeta { color: var(--muted); font-size: 12px; }
    .small-hint { color: var(--muted); font-size: 12px; margin-top: 6px; }
    .copybox { display:flex; gap:8px; align-items:center; margin-top:8px; background:#0f0f14; border:1px dashed var(--gray-700); border-radius:10px; padding:8px; }

    /* Badge */
    .notif-link { position: relative; display: inline-flex; align-items: center; gap: 6px; }
    .badge {
      position: absolute; top: -6px; right: -6px;
      min-width: 18px; height: 18px; padding: 0 6px;
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--purple); color: #fff; border-radius: 999px; font-size: 11px;
      border: 2px solid #0b0b10;
    }

    @media (max-width: 980px) {
      .community-row { grid-template-columns: repeat(2, 1fr); }
      .custom-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 560px) {
      .community-row, .custom-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body class="dark">
  <header class="topbar">
    <h1 class="topbar__title">LCM ‚Äî Communities</h1>
    <div class="topbar__actions">
      <a href="notifications.html" class="btn notif-link" id="nav-notifs" title="Notifications">üîî
        <span class="badge" id="badge-notifs" hidden>0</span>
      </a>
      <a href="dashboard.html" class="btn btn-secondary">‚Üê Dashboard</a>
      <button id="sign-out" class="btn">Sign Out</button>
    </div>
  </header>

  <main class="dashboard">
    <div class="wrap">
      <p id="whoami" class="welcome-chip">Checking your session‚Ä¶</p>

      <!-- ===== BUILT-IN COMMUNITIES ===== -->
      <section aria-label="My Communities">
        <h2 style="margin: 10px 0; color: var(--text);">MY COMMUNITIES</h2>
        <div class="community-row" id="community-row"></div>
      </section>

      <!-- ===== USER-CREATED COMMUNITIES ===== -->
      <section aria-label="Custom Communities" style="margin-top:20px;">
        <div class="bar">
          <h2 style="margin:0;color:var(--text);">YOUR CUSTOM COMMUNITIES</h2>
          <div class="spacer"></div>
          <button id="btn-open-form" class="btn-primary">+ Create Community</button>
        </div>

        <!-- Inline create form -->
        <form id="create-form" class="inline-form" autocomplete="off">
          <label>
            <span style="color:var(--muted);">Community Name</span>
            <input id="cc-name" type="text" placeholder="e.g., Kararitiri Neighbors" minlength="3" maxlength="40" required />
          </label>
          <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
            <label style="display:flex; align-items:center; gap:6px;">
              <input id="cc-private" type="checkbox" checked />
              <span>Private (invite only)</span>
            </label>
            <div class="spacer"></div>
            <button id="btn-cancel" type="button" class="btn-secondary">Cancel</button>
            <button id="btn-create" type="submit" class="btn-primary">Create</button>
          </div>
          <div id="cc-status" class="hint" style="margin-top:6px;"></div>
        </form>

        <div id="custom-grid" class="custom-grid"></div>
      </section>
    </div>
  </main>

  <!-- ===== INVITE MODAL (same as previous step) ===== -->
  <div id="invite-modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="invite-title">
      <div class="modal-head">
        <div id="invite-title" class="modal-title">Invite to Community</div>
        <div class="spacer"></div>
        <button id="invite-close" class="btn-ghost" type="button">Close</button>
      </div>
      <div class="small-hint" id="invite-comm-name" style="margin-bottom:6px;"></div>
      <div class="tabs">
        <button id="tab-user" class="tab active" type="button">Search by username</button>
        <button id="tab-email" class="tab" type="button">Invite by email</button>
      </div>
      <div id="pane-user">
        <div class="field"><input id="invite-search" type="text" placeholder="Type a name to search‚Ä¶" /></div>
        <div class="results" id="invite-results"></div>
        <div class="small-hint">Tip: results show users from <em>user_profiles.display_name</em>.</div>
      </div>
      <div id="pane-email" style="display:none;">
        <div class="field"><input id="invite-email" type="email" placeholder="friend@example.com" /></div>
        <div class="row">
          <button id="invite-email-send" class="btn-primary" type="button">Send invite</button>
          <div id="invite-email-status" class="small-hint"></div>
        </div>
      </div>
      <div id="invite-success" class="copybox" style="display:none;">
        <span class="small-hint">Invite created. Share link (optional):</span>
        <input id="invite-link" type="text" readonly style="flex:1;background:transparent;border:none;color:var(--text);" />
        <button id="invite-copy" class="btn-ghost" type="button">Copy</button>
        <a id="invite-to-notifs" class="btn-ghost" href="notifications.html">Open Notifications</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const who = document.getElementById("whoami");
      const out = document.getElementById("sign-out");
      const row = document.getElementById('community-row');
      const customGrid = document.getElementById('custom-grid');
      const badge = document.getElementById('badge-notifs');
      const navNotifs = document.getElementById('nav-notifs');

      if (!window.sb) { who.textContent = "Supabase not initialized."; return; }
      out?.addEventListener("click", async () => { await window.sb.auth.signOut(); window.location.href = "index.html"; });
      const { data: { session } } = await window.sb.auth.getSession();
      if (!session) { window.location.href = "index.html"; return; }
      who.textContent = `Signed in as: ${session.user?.email || "(no email)"}`;

      // Unread badge
      async function refreshNotifBadge() {
        const { count } = await window.sb
          .from('notifications')
          .select('*', { count: 'exact', head: true })
          .eq('is_read', false);
        const c = count || 0;
        if (c > 0) {
          badge.hidden = false;
          badge.textContent = c > 99 ? '99+' : String(c);
          navNotifs.title = `${c} unread notification${c > 1 ? 's' : ''}`;
        } else {
          badge.hidden = true;
          navNotifs.title = 'Notifications';
        }
      }
      await refreshNotifBadge();
      setInterval(refreshNotifBadge, 20000);

      // ===== Built-in communities (verifiers) =====
      const { data: comms } = await window.sb.from('communities').select('code,label').order('code', { ascending: true });
      row.innerHTML = '';
      const codes = ['HOME','SCHOOL','CHURCH','WORK','TEAM'];
      const byCode = new Map((comms||[]).map(c => [c.code, c]));
      for (const code of codes) {
        const label = byCode.get(code)?.label || code;
        const card = document.createElement('div');
        card.className = 'community-card';
        card.innerHTML = `
          <div class="card-head">
            <a class="card-title" href="community.html?code=${code}">${label}</a>
            <span class="count-pill" id="count-${code}">0</span>
          </div>
          <div class="actions">
            <button class="btn-ghost" id="toggle-${code}" aria-expanded="false">View verifiers</button>
          </div>
          <ul class="list" id="list-${code}"></ul>
        `;
        row.appendChild(card);
      }

      async function loadVerifiersFor(code) {
        const { data, error } = await window.sb
          .from('verifiers')
          .select('name')
          .eq('owner_user_id', session.user.id)
          .eq('community', code)
          .order('name', { ascending: true });
        if (error) return [];
        return data || [];
      }
      for (const code of codes) {
        const listEl = document.getElementById(`list-${code}`);
        const countEl = document.getElementById(`count-${code}`);
        const toggle = document.getElementById(`toggle-${code}`);
        const verifiers = await loadVerifiersFor(code);
        countEl.textContent = verifiers.length;
        listEl.innerHTML = '';
        for (const v of verifiers) {
          const li = document.createElement('li');
          li.textContent = v.name || '(unnamed verifier)';
          listEl.appendChild(li);
        }
        toggle.addEventListener('click', () => {
          const isOpen = listEl.classList.toggle('show');
          toggle.setAttribute('aria-expanded', String(isOpen));
          toggle.textContent = isOpen ? 'Hide verifiers' : 'View verifiers';
        });
      }

      // ===== Create + list custom communities =====
      const form = document.getElementById('create-form');
      const btnOpen = document.getElementById('btn-open-form');
      const btnCancel = document.getElementById('btn-cancel');
      const nameInput = document.getElementById('cc-name');
      const privateInput = document.getElementById('cc-private');
      const ccStatus = document.getElementById('cc-status');

      const slugify = (s) => s.toLowerCase().trim().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').replace(/-+/g, '-').slice(0, 40);

      btnOpen.addEventListener('click', () => { form.classList.add('show'); nameInput.focus(); });
      btnCancel.addEventListener('click', () => { form.classList.remove('show'); ccStatus.textContent = ''; form.reset(); privateInput.checked = true; });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = nameInput.value.trim();
        if (name.length < 3) { ccStatus.textContent = 'Name must be at least 3 characters.'; return; }
        const slug = slugify(name);
        const isPrivate = !!privateInput.checked;

        ccStatus.textContent = 'Creating‚Ä¶';
        // 1) create the community, return id+name
        const { data: created, error } = await window.sb
          .from('user_custom_communities')
          .insert({ owner_user_id: session.user.id, name, slug, is_private: isPrivate })
          .select('id, name')
          .single();

        if (error) { ccStatus.textContent = error.message; return; }

        // 2) ensure owner is also a member so they can see it under membership-restricted SELECTs
        await window.sb.from('community_members').insert({ community_id: created.id, user_id: session.user.id, role: 'owner' }).select().single().catch(() => {});

        ccStatus.textContent = 'Created ‚úÖ';
        await loadCustomCommunities();
        setTimeout(() => { form.classList.remove('show'); ccStatus.textContent = ''; form.reset(); privateInput.checked = true; }, 400);
      });

      async function loadCustomCommunities() {
        customGrid.innerHTML = '';
        const { data: communities, error } = await window.sb
          .from('user_custom_communities')
          .select('id, name, slug, is_private, owner_user_id')
          .order('created_at', { ascending: false });
        if (error) { console.error('Load custom communities error:', error); return; }

        for (const c of (communities || [])) {
          // member count
          const { data: members } = await window.sb
            .from('community_members')
            .select('user_id')
            .eq('community_id', c.id);
          const count = members?.length || 0;

          // am I a member?
          const { data: myMem } = await window.sb
            .from('community_members')
            .select('user_id')
            .eq('community_id', c.id)
            .eq('user_id', session.user.id)
            .maybeSingle();
          const amMember = !!myMem;
          const amOwner  = c.owner_user_id === session.user.id;

          const card = document.createElement('div');
          card.className = 'community-card';
          card.innerHTML = `
            <div class="card-head">
              <a class="card-title" href="community.html?id=${c.id}">${c.name}</a>
              <span class="count-pill">${count} members</span>
            </div>
            <div class="meta">
              ${c.is_private ? 'Private' : 'Public'} ‚Ä¢ ${c.slug}
            </div>
            <div class="actions" style="margin-top:8px;">
              ${amOwner ? `<a class="btn-ghost" href="#" data-action="invite" data-id="${c.id}" data-owner="${c.owner_user_id}">Invite</a>` : ''}
              ${amOwner ? `<a class="btn-ghost" href="#" data-action="delete" data-id="${c.id}">Delete</a>` : ''}
              ${!amOwner && amMember ? `<a class="btn-ghost" href="#" data-action="leave" data-id="${c.id}">Leave</a>` : ''}
              <a class="btn-ghost" href="#" data-action="manage" data-id="${c.id}">Manage</a>
            </div>
          `;
          customGrid.appendChild(card);
        }
      }

      await loadCustomCommunities();

      // ===== Invite modal (existing from last step) =====
      const modal = document.getElementById('invite-modal');
      const modalClose = document.getElementById('invite-close');
      const paneUser = document.getElementById('pane-user');
      const paneEmail = document.getElementById('pane-email');
      const tabUser = document.getElementById('tab-user');
      const tabEmail = document.getElementById('tab-email');
      const searchInput = document.getElementById('invite-search');
      const resultsEl = document.getElementById('invite-results');
      const emailInput = document.getElementById('invite-email');
      const emailSend = document.getElementById('invite-email-send');
      const emailStatus = document.getElementById('invite-email-status');
      const successBox = document.getElementById('invite-success');
      const linkInput = document.getElementById('invite-link');
      const linkCopy = document.getElementById('invite-copy');
      const commNameEl = document.getElementById('invite-comm-name');

      let currentCommunityId = null;

      function openModal(communityId, communityName) {
        currentCommunityId = communityId;
        commNameEl.textContent = communityName ? `Community: ${communityName}` : '';
        modal.classList.add('open'); modal.setAttribute('aria-hidden', 'false');
        resultsEl.innerHTML = ''; searchInput.value = ''; emailInput.value = ''; emailStatus.textContent = '';
        successBox.style.display = 'none'; linkInput.value = ''; setTab('user');
        setTimeout(() => searchInput.focus(), 50);
      }
      function closeModal() { modal.classList.remove('open'); modal.setAttribute('aria-hidden', 'true'); }
      modalClose.addEventListener('click', closeModal);
      modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

      function setTab(which) {
        const user = which === 'user';
        tabUser.classList.toggle('active', user);
        tabEmail.classList.toggle('active', !user);
        paneUser.style.display = user ? 'block' : 'none';
        paneEmail.style.display = user ? 'none' : 'block';
      }
      tabUser.addEventListener('click', () => setTab('user'));
      tabEmail.addEventListener('click', () => setTab('email'));

      // Debounced username search
      let t = null;
      searchInput.addEventListener('input', () => { if (t) clearTimeout(t); t = setTimeout(runSearch, 250); });
      async function runSearch() {
        const q = searchInput.value.trim();
        resultsEl.innerHTML = '';
        if (!q) return;
        const { data, error } = await window.sb.rpc('search_user_directory', { q, limit_count: 10 });
        if (error) { console.error('search_user_directory error:', error); return; }
        for (const u of (data || [])) {
          const item = document.createElement('div');
          item.className = 'result-item';
          const fallback = 'https://picsum.photos/seed/dir/72';
          item.innerHTML = `
            <img class="avatar" src="${u.avatar_url || fallback}" onerror="this.src='${fallback}'" alt="">
            <div style="flex:1;">
              <div class="rname">${u.display_name || '(Unnamed user)'}</div>
              <div class="rmeta">${u.user_id}</div>
            </div>
            <button class="btn-ghost" data-act="invite-user" data-uid="${u.user_id}">Invite</button>
          `;
          resultsEl.appendChild(item);
        }
        if (!data || data.length === 0) {
          const none = document.createElement('div'); none.className = 'small-hint'; none.textContent = 'No users found.'; resultsEl.appendChild(none);
        }
      }

      // Invite by user_id from results
      resultsEl.addEventListener('click', async (e) => {
        const btn = e.target.closest('[data-act="invite-user"]'); if (!btn) return;
        if (!currentCommunityId) return;
        const { data, error } = await window.sb.from('community_invites')
          .insert({ community_id: currentCommunityId, inviter_user_id: session.user.id, invitee_user_id: btn.getAttribute('data-uid') })
          .select('token').single();
        if (error) { alert(error.message || 'Could not create invite'); return; }
        showSuccessLink(data?.token); await refreshNotifBadge();
      });

      // Invite by email
      emailSend.addEventListener('click', async () => {
        if (!currentCommunityId) return;
        const em = emailInput.value.trim();
        if (!em || !em.includes('@')) { emailStatus.textContent = 'Enter a valid email.'; return; }
        emailStatus.textContent = 'Sending‚Ä¶';
        const { data, error } = await window.sb.from('community_invites')
          .insert({ community_id: currentCommunityId, inviter_user_id: session.user.id, invitee_email: em })
          .select('token').single();
        if (error) { emailStatus.textContent = error.message; return; }
        emailStatus.textContent = 'Invite created ‚úÖ (notification sent).';
        showSuccessLink(data?.token); await refreshNotifBadge();
      });

      function showSuccessLink(token) {
        if (token) {
          const url = `${location.origin}${location.pathname.replace(/[^/]*$/, '')}invite.html?token=${token}`;
          linkInput.value = url; successBox.style.display = 'flex';
        } else { successBox.style.display = 'none'; }
      }
      linkCopy.addEventListener('click', async () => { try { await navigator.clipboard.writeText(linkInput.value); linkCopy.textContent = 'Copied'; setTimeout(()=>linkCopy.textContent='Copy',800); } catch {} });

      // Open Invite modal (owner only) + Delete/Leave/Manage
      customGrid.addEventListener('click', async (e) => {
        const a = e.target.closest('a[data-action]'); if (!a) return;
        e.preventDefault();
        const action = a.getAttribute('data-action');
        const communityId = a.getAttribute('data-id');

        if (action === 'invite') {
          const card = a.closest('.community-card');
          const name = card?.querySelector('.card-title')?.textContent || '';
          openModal(communityId, name);
          return;
        }

        if (action === 'delete') {
          if (!confirm('Delete this community? This removes all members and invites.')) return;
          const { error } = await window.sb.rpc('delete_community', { p_id: communityId });
          if (error) { alert(error.message || 'Could not delete'); return; }
          await loadCustomCommunities();
          return;
        }

        if (action === 'leave') {
          if (!confirm('Leave this community?')) return;
          const { error } = await window.sb
            .from('community_members')
            .delete()
            .eq('community_id', communityId)
            .eq('user_id', session.user.id);
          if (error) { alert(error.message || 'Could not leave'); return; }
          await loadCustomCommunities();
          return;
        }

        if (action === 'manage') {
          /* ONE-LINER CHANGE: go to the manage page */
          window.location.href = `community_manage.html?id=${communityId}`;
          return;
        }
      });
    });
  </script>
</body>
</html>
